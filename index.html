<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartBooking - ระบบจองใช้งานทรัพยากร</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Prompt', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; overflow: hidden; height: 100vh; background-color: #f8fafc; }
        #app { height: 100vh; display: flex; flex-direction: column; }
        
        /* ส่วนเนื้อหาที่เลื่อนได้จริง */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes scan-line {
            0% { top: 15%; }
            100% { top: 85%; }
        }
        .animate-scan-line { animation: scan-line 2s linear infinite; }
        
        #reader { width: 100% !important; border: none !important; }
        #reader video { border-radius: 1rem; object-fit: cover; }
        
        .ticket-cutout {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), 
                              radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-900">

    <div id="app">
        <!-- Loading State -->
        <div class="flex items-center justify-center h-full text-indigo-600">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-600 border-opacity-30"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbId = "smart-booking-v4"; 

        window.state = {
            user: null,
            studentId: localStorage.getItem('student_id') || '',
            isLoggedIn: !!localStorage.getItem('student_id'),
            isAdmin: localStorage.getItem('is_admin') === 'true',
            settings: { 
                projectName: "Global Access Project",
                maxHoursPerDay: 2,
                maxTotalHours: 10,
                startTime: "09:00", 
                endTime: "18:00", 
                availableDays: [1, 2, 3, 4, 5], 
                startDate: new Date().toISOString().split('T')[0], 
                endDate: "" 
            },
            resources: [],
            bookings: [],
            selectedResource: null,
            selectedDate: new Date().toISOString().split('T')[0],
            selectedSlots: [],
            view: 'selection',
            activeBookings: [],
            error: null,
            isScanning: false
        };

        let html5QrScanner = null;
        const DAYS_TH = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];

        // --- Logic: Time Range Combination ---
        window.formatBookingRanges = (slots) => {
            if (!slots || slots.length === 0) return "ไม่มีข้อมูลเวลา";
            const hours = slots.map(s => parseInt(s.split(':')[0])).sort((a, b) => a - b);
            let ranges = [];
            if (hours.length > 0) {
                let start = hours[0];
                let end = hours[0];
                for (let i = 1; i < hours.length; i++) {
                    if (hours[i] === end + 1) { end = hours[i]; }
                    else {
                        ranges.push(`${start.toString().padStart(2, '0')}:00-${end.toString().padStart(2, '0')}:59`);
                        start = hours[i];
                        end = hours[i];
                    }
                }
                ranges.push(`${start.toString().padStart(2, '0')}:00-${end.toString().padStart(2, '0')}:59`);
            }
            return ranges.join(", ");
        };

        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    window.state.user = u;
                    if (u) listenToData();
                });
            } catch (err) { showError("Firebase Error: " + err.message); }
        }

        function listenToData() {
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), (s) => {
                if (s.exists()) window.state.settings = s.data();
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), (s) => {
                window.state.resources = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), (s) => {
                window.state.bookings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        function showError(msg) {
            window.state.error = msg;
            render();
            setTimeout(() => { window.state.error = null; render(); }, 6000);
        }

        // --- Actions ---
        window.render = render;
        window.setView = (v) => { 
            window.state.view = v; 
            if (v !== 'scanner' && html5QrScanner) {
                html5QrScanner.clear();
                html5QrScanner = null;
                window.state.isScanning = false;
            }
            render(); 
        };

        window.handleLogin = (e) => {
            e.preventDefault();
            const input = document.getElementById('login_sid').value.trim();
            if (input === "Admin123") {
                window.state.isAdmin = true;
                window.state.isLoggedIn = true;
                window.state.studentId = "ADMIN";
                localStorage.setItem('is_admin', 'true');
            } else if (input.length >= 5) {
                window.state.isAdmin = false;
                window.state.isLoggedIn = true;
                window.state.studentId = input;
                localStorage.setItem('student_id', input);
                localStorage.setItem('is_admin', 'false');
            } else { return showError("กรุณาระบุข้อมูลที่ถูกต้อง"); }
            render();
        };

        window.logout = () => { 
            localStorage.clear();
            window.state.isLoggedIn = false; 
            window.state.isAdmin = false;
            window.state.view = 'selection';
            render(); 
        };

        window.selectResource = (id, name) => { 
            window.state.selectedResource = { id, name }; 
            window.state.selectedSlots = [];
            window.state.view = 'calendar'; 
            render(); 
        };

        window.toggleSlotSelection = (slot) => {
            const index = window.state.selectedSlots.indexOf(slot);
            if (index > -1) {
                window.state.selectedSlots.splice(index, 1);
            } else {
                const dailyBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
                if (dailyBooked + window.state.selectedSlots.length >= window.state.settings.maxHoursPerDay) {
                    return showError(`เกินโควตาต่อวัน! จองได้สูงสุด ${window.state.settings.maxHoursPerDay} ชม./วัน`);
                }
                const totalBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;
                if (totalBooked + window.state.selectedSlots.length >= window.state.settings.maxTotalHours) {
                    return showError(`เกินโควตาทั้งหมด! จองได้สูงสุด ${window.state.settings.maxTotalHours} ชม. ต่อโปรเจกต์`);
                }
                window.state.selectedSlots.push(slot);
            }
            render();
        };

        window.confirmBookingAction = async () => {
            if (window.state.selectedSlots.length === 0) return;
            try {
                const newItems = [];
                for (const slot of window.state.selectedSlots) {
                    const data = {
                        resourceId: window.state.selectedResource.id,
                        resourceName: window.state.selectedResource.name,
                        date: window.state.selectedDate,
                        slot,
                        studentId: window.state.studentId,
                        email: `${window.state.studentId}@kmitl.ac.th`,
                        status: 'booked',
                        createdAt: serverTimestamp()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), data);
                    newItems.push({ id: docRef.id, ...data });
                }
                window.state.activeBookings = newItems;
                window.state.selectedSlots = [];
                window.state.view = 'pass';
                render();
            } catch (err) { showError("Booking failed: " + err.message); }
        };

        window.viewPass = (list) => { window.state.activeBookings = list; window.state.view = 'pass'; render(); };

        window.initScanner = () => {
            if (window.state.isScanning) return;
            window.state.isScanning = true;
            html5QrScanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
            html5QrScanner.render((text) => {
                const targetId = window.state.activeBookings[0]?.resourceId;
                if (text === targetId) {
                    const now = new Date();
                    const hourNow = now.getHours();
                    const today = now.toISOString().split('T')[0];
                    const hasCurrentSlot = window.state.activeBookings.some(b => b.date === today && parseInt(b.slot.split(':')[0]) === hourNow);
                    
                    if (hasCurrentSlot) {
                        html5QrScanner.clear().then(() => {
                            window.state.isScanning = false;
                            window.processCheckIn(targetId);
                        });
                    } else { showError("ยังไม่ถึงเวลา หรือเลยเวลาจองของคุณแล้ว"); }
                } else { showError("QR ไม่ถูกต้องสำหรับอุปกรณ์นี้"); }
            }, () => {});
        };

        window.processCheckIn = async (resId) => {
            for (const b of window.state.activeBookings) {
                await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), { status: 'checked_in', checkInAt: new Date().toISOString() });
            }
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', resId), { status: 'in_use', currentStudent: window.state.studentId, startedAt: new Date().toISOString() });
            window.state.view = 'selection';
            window.state.activeBookings = [];
            alert("เช็คอินสำเร็จ!");
            render();
        };

        window.stopResource = async (id) => {
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id), { status: 'idle', currentStudent: null, startedAt: null });
        };

        window.saveSettings = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const days = DAYS_TH.map((_, i) => f.get(`day-${i}`) ? i : null).filter(x => x !== null);
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                projectName: f.get('projectName'),
                maxHoursPerDay: parseInt(f.get('maxHoursDay')),
                maxTotalHours: parseInt(f.get('maxHoursTotal')),
                startTime: f.get('startTime'),
                endTime: f.get('endTime'),
                startDate: f.get('startDate'),
                endDate: f.get('endDate'),
                availableDays: days
            });
            alert("บันทึกการตั้งค่าแล้ว");
            render();
        };

        window.addRes = async (e) => {
            e.preventDefault();
            const name = e.target.resName.value.trim();
            if (name) await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), { name, status: 'idle' });
            e.target.reset();
        };

        window.delBooking = async (id) => { if(confirm("ลบการจอง?")) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', id)); };
        window.clearHistory = async () => { if(confirm("ล้างทั้งหมด?")) for(const b of window.state.bookings) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id)); };
        window.clearByDay = async () => {
            const d = prompt("ระบุวันที่ (YYYY-MM-DD):");
            if(d) for(const b of window.state.bookings.filter(x => x.date === d)) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
        };

        const isServiceAvailable = () => {
            const d = new Date(window.state.selectedDate);
            const isInRange = (!window.state.settings.startDate || window.state.selectedDate >= window.state.settings.startDate) &&
                              (!window.state.settings.endDate || window.state.selectedDate <= window.state.settings.endDate);
            return isInRange && window.state.settings.availableDays.includes(d.getDay());
        };

        // --- Render Engine ---
        function render() {
            const app = document.getElementById('app');
            if (!window.state.isLoggedIn) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderHeader()}
                    <div class="scrollable-content">
                        <main class="max-w-xl mx-auto px-4 py-6">
                            ${window.state.error ? renderError() : ''}
                            ${window.state.isAdmin ? renderAdminUI() : renderUserUI()}
                        </main>
                    </div>
                    ${renderFooter()}
                    ${renderQRModalUI()}
                    ${renderStickyAction()}
                `;
            }
            lucide.createIcons();
            if (window.state.view === 'scanner') setTimeout(window.initScanner, 100);
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-6">
                    <div class="max-w-sm w-full bg-white rounded-3xl p-8 shadow-xl border border-slate-100 text-center animate-in fade-in duration-500">
                        <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-indigo-100"><i data-lucide="shield-check" size="32"></i></div>
                        <h1 class="text-3xl font-bold text-slate-800 mb-1 leading-none tracking-tight">SmartBooking</h1>
                        <p class="text-slate-400 text-[10px] font-bold uppercase mt-2 tracking-widest opacity-60">Identity Portal</p>
                        <form onsubmit="handleLogin(event)" class="mt-10 space-y-5">
                            <input id="login_sid" type="text" placeholder="รหัสนักศึกษา" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-100 font-bold text-lg text-center outline-none focus:ring-2 focus:ring-indigo-500 shadow-inner" required>
                            <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg hover:bg-indigo-700 active:scale-95 transition-all text-lg">เข้าสู่ระบบ</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-white/90 backdrop-blur-md border-b border-slate-100 flex-none h-16 px-4">
                    <div class="max-w-2xl mx-auto h-full flex items-center justify-between">
                        <div class="flex items-center gap-2.5 cursor-pointer" onclick="setView('selection'); window.state.selectedResource=null; render();">
                            <div class="w-8 h-8 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-md active:scale-90 transition-transform"><i data-lucide="layers" size="18"></i></div>
                            <div>
                                <h1 class="font-bold text-base leading-none text-slate-800">SmartBooking</h1>
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5 truncate max-w-[120px]">${window.state.settings.projectName}</p>
                            </div>
                        </div>
                        <button onclick="logout()" class="p-2.5 bg-slate-50 text-slate-400 hover:text-red-500 rounded-xl border border-slate-100 active:scale-90 transition-all"><i data-lucide="log-out" size="18"></i></button>
                    </div>
                </header>
            `;
        }

        function renderUserUI() {
            if (window.state.view === 'scanner') return renderScannerUI();
            if (window.state.view === 'pass') return renderReceiptUI();
            if (!window.state.selectedResource) return renderResourceMenu();
            return renderCalendarUI();
        }

        function renderResourceMenu() {
            return `
                <div class="space-y-6 page-transition">
                    <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-xl relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        <p class="text-[9px] font-bold uppercase tracking-widest opacity-60 mb-1">Identified Session</p>
                        <h2 class="text-3xl font-black tracking-tighter leading-none">${window.state.studentId}</h2>
                        <div class="flex items-center gap-2 text-indigo-200 text-[9px] font-bold mt-6 bg-white/10 w-fit px-3 py-1 rounded-lg border border-white/5 uppercase tracking-widest">
                            <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse shadow-[0_0_8px_#4ade80]"></div>
                            <span>Cloud Synced</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        ${window.state.resources.map(res => `
                            <button onclick="selectResource('${res.id}', '${res.name}')" class="group bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all text-left flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center transition-all ${res.status === 'in_use' ? 'bg-orange-50 text-orange-500 shadow-inner' : 'bg-slate-50 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white'}">
                                        <i data-lucide="map-pin" size="18"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-sm text-slate-800 leading-tight">${res.name}</h3>
                                        <div class="flex items-center gap-1.5 mt-0.5 leading-none">
                                            <div class="w-1.5 h-1.5 rounded-full ${res.status === 'in_use' ? 'bg-orange-400 animate-pulse' : 'bg-green-400'}"></div>
                                            <span class="text-[8px] font-bold uppercase tracking-widest ${res.status === 'in_use' ? 'text-orange-500' : 'text-green-500'}">
                                                ${res.status === 'in_use' ? `In Use by ${res.currentStudent}` : 'Available'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" size="18" class="text-slate-200 group-hover:text-indigo-600 transition-all"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCalendarUI() {
            const hStart = parseInt(window.state.settings.startTime.split(':')[0]);
            const hEnd = parseInt(window.state.settings.endTime.split(':')[0]);
            const slots = [];
            for(let i=hStart; i<hEnd; i++) slots.push(`${i.toString().padStart(2, '0')}:00`);
            
            const myBookingsToday = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate && b.resourceId === window.state.selectedResource.id);
            const bookedD = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
            const bookedT = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;

            return `
                <div class="space-y-4 page-transition">
                    <button onclick="setView('selection'); window.state.selectedResource=null; render();" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 text-[10px] font-bold uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="arrow-left" size="14"></i> เปลี่ยนจุด</button>
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-xl space-y-6">
                        <div class="flex items-center gap-3 text-indigo-600 leading-none">
                            <div class="w-9 h-9 bg-indigo-50 rounded-lg flex items-center justify-center shadow-inner"><i data-lucide="calendar" size="18"></i></div>
                            <div><h2 class="text-lg font-bold text-slate-800">${window.state.selectedResource.name}</h2><p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-1">Resource Schedule</p></div>
                        </div>
                        <input type="date" value="${window.state.selectedDate}" onchange="window.state.selectedDate=this.value; window.state.selectedSlots=[]; render();" class="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-100 font-bold text-slate-800 text-center shadow-inner outline-none focus:ring-1 focus:ring-indigo-300">
                        
                        ${!isServiceAvailable() ? `<div class="p-10 bg-orange-50 rounded-2xl text-center"><p class="font-bold text-orange-700 text-sm">ไม่เปิดให้บริการในวันที่เลือก</p></div>` : `
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-indigo-600 p-3 rounded-xl text-white shadow-md">
                                    <p class="text-[7px] font-bold uppercase opacity-60 mb-1 leading-none tracking-wider text-left">Daily Quota</p>
                                    <p class="text-xl font-black leading-none text-left">${bookedD + window.state.selectedSlots.length} / ${window.state.settings.maxHoursPerDay} <span class="text-[8px] opacity-40 uppercase">hr</span></p>
                                </div>
                                <div class="bg-slate-900 p-3 rounded-xl text-white shadow-md">
                                    <p class="text-[7px] font-bold uppercase opacity-60 mb-1 leading-none tracking-wider text-left">Total Quota</p>
                                    <p class="text-xl font-black leading-none text-left">${bookedT + window.state.selectedSlots.length} / ${window.state.settings.maxTotalHours} <span class="text-[8px] opacity-40 uppercase">hr</span></p>
                                </div>
                            </div>
                            ${myBookingsToday.length > 0 ? `<button onclick='viewPass(${JSON.stringify(myBookingsToday).replace(/'/g, "&apos;")})' class="w-full p-3 bg-green-50 border border-green-200 text-green-700 rounded-xl text-[9px] font-bold uppercase tracking-widest flex items-center justify-center gap-2 shadow-sm animate-pulse"><i data-lucide="ticket" size="14"></i> ดูใบจองที่คุณทำไว้</button>` : ''}
                            <div class="grid grid-cols-1 gap-2">
                                ${slots.map(slot => {
                                    const bOthers = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id && b.studentId !== window.state.studentId);
                                    const bMine = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id && b.studentId === window.state.studentId);
                                    const isSelecting = window.state.selectedSlots.includes(slot);
                                    let btnClass = "bg-white border-slate-100 text-slate-500 hover:border-indigo-300 active:scale-[0.99]";
                                    let sText = "พร้อมจอง"; let act = `toggleSlotSelection('${slot}')`;
                                    if (bOthers) { btnClass = "bg-slate-50 border-slate-100 text-slate-300 opacity-40 cursor-not-allowed"; sText = `Booked ID:${bOthers.studentId.slice(-4)}`; act = ""; }
                                    else if (bMine) { btnClass = "bg-green-50 border-green-500 text-green-700 shadow-sm"; sText = "จองแล้ว (ยกเลิก)"; act = `delBooking('${bMine.id}')`; }
                                    else if (isSelecting) { btnClass = "bg-indigo-600 border-indigo-600 text-white shadow-md scale-[1.01] z-10 ring-2 ring-indigo-100"; sText = "กำลังเลือก"; }
                                    return `<button onclick="${act}" class="relative p-4 rounded-xl border-2 transition-all flex justify-between items-center ${btnClass}"><div class="text-left leading-none"><span class="text-sm font-bold">${slot} - ${slot.split(':')[0]}:59</span><p class="text-[7px] font-bold uppercase mt-1 opacity-60 text-left tracking-widest">${sText}</p></div><div class="w-6 h-6 rounded-full flex items-center justify-center ${bMine || isSelecting ? 'bg-white/20' : 'bg-slate-50'} shadow-inner">${bMine || isSelecting ? '<i data-lucide="check" size="12"></i>' : '<i data-lucide="plus" size="12" class="opacity-20"></i>'}</div></button>`;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderReceiptUI() {
            const dateStr = window.state.activeBookings[0]?.date;
            const resName = window.state.activeBookings[0]?.resourceName;
            const slots = window.state.activeBookings.map(b => b.slot);
            const timeText = window.formatBookingRanges(slots);

            return `
                <div class="max-w-sm mx-auto animate-in zoom-in duration-500 page-transition">
                    <div class="bg-white rounded-3xl overflow-hidden shadow-2xl border border-slate-100 relative">
                        <div class="bg-indigo-600 p-8 text-white text-center relative overflow-hidden">
                            <i data-lucide="shield-check" size="36" class="mx-auto mb-3 opacity-60"></i>
                            <h2 class="text-2xl font-bold mb-0.5 tracking-tight leading-none text-white">ยืนยันการจอง</h2>
                            <p class="text-indigo-200 text-[8px] font-bold uppercase tracking-widest opacity-60 leading-none mt-2">Authentication Pass</p>
                        </div>
                        <div class="p-8 space-y-6 ticket-cutout text-left">
                            <div class="pb-4 border-b border-slate-100"><p class="text-[8px] font-bold text-slate-400 uppercase mb-1 tracking-widest text-left">Facility Name</p><p class="text-lg font-black text-slate-800 leading-tight text-left">${resName}</p></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-left"><p class="text-[8px] font-bold text-slate-400 uppercase mb-1 leading-none text-left">Student ID</p><p class="text-sm font-bold text-slate-800 text-left">${window.state.studentId}</p></div>
                                <div class="text-left"><p class="text-[8px] font-bold text-slate-400 uppercase mb-1 leading-none text-left">Booking Date</p><p class="text-sm font-bold text-slate-800 text-left">${dateStr}</p></div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-center">
                                <p class="text-[8px] font-bold text-slate-400 uppercase mb-3 leading-none tracking-widest text-center">Approved Service Hours</p>
                                <p class="text-indigo-600 font-black text-sm tracking-tight text-center">${timeText}</p>
                                <div class="mt-6 flex items-center gap-2 justify-center text-blue-600 bg-white p-3 rounded-xl border border-blue-50 shadow-sm">
                                    <i data-lucide="mail" size="14"></i>
                                    <p class="text-[7px] font-bold uppercase leading-none text-left">Receipt: ${window.state.studentId}@kmitl.ac.th</p>
                                </div>
                            </div>
                            <div class="pt-6 border-t-2 border-dashed border-slate-100 flex flex-col gap-3">
                                <button onclick="setView('scanner')" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl flex items-center justify-center gap-2 shadow-lg hover:bg-black transition-all active:scale-95 text-center">
                                    <i data-lucide="qr-code" size="20"></i> เปิดกล้องเช็คอิน
                                </button>
                                <button onclick="setView('selection'); window.state.activeBookings=[]; render();" class="w-full text-[9px] font-bold text-slate-400 uppercase tracking-widest text-center py-2">กลับสู่หน้าหลัก</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScannerUI() {
            return `
                <div class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-6 text-white animate-in fade-in duration-500 overflow-hidden text-center">
                    <h2 class="text-2xl font-bold mb-1 tracking-tight text-white">เช็คอินเข้าใช้งาน</h2>
                    <p class="text-slate-400 text-[10px] font-medium uppercase tracking-[0.2em] opacity-70 mt-2 mb-10">Scan Resource Key</p>
                    <div class="relative w-full max-w-sm aspect-square bg-black rounded-3xl overflow-hidden border-8 border-white/5 shadow-2xl">
                        <div id="reader" class="w-full h-full"></div>
                        <div class="absolute inset-0 pointer-events-none border-[3rem] border-slate-900/60 z-10 shadow-inner"></div>
                        <div class="absolute top-1/2 left-0 right-0 h-1 bg-indigo-500 shadow-[0_0_20px_#6366f1] animate-scan-line z-20"></div>
                    </div>
                    <div class="mt-12 space-y-4 w-full max-w-sm">
                        <div class="bg-indigo-600/20 border border-indigo-500/20 p-5 rounded-2xl backdrop-blur-md">
                            <p class="text-[8px] font-bold uppercase tracking-widest text-indigo-400 mb-1 leading-none">Scanning for ID:</p>
                            <p class="font-bold text-base leading-none uppercase">${window.state.activeBookings[0]?.resourceName}</p>
                        </div>
                        <button onclick="setView('pass')" class="w-full py-4 bg-white/5 text-white font-bold rounded-2xl border border-white/10 text-[9px] uppercase tracking-widest text-center">ยกเลิกขั้นตอนการสแกน</button>
                    </div>
                </div>
            `;
        }

        function renderAdminUI() {
            return `
                <div class="space-y-8 page-transition text-left pb-20">
                    <section class="bg-white p-6 rounded-3xl border border-slate-100 shadow-xl space-y-6 border-t-8 border-indigo-600 text-left">
                        <h2 class="text-lg font-bold text-indigo-600 flex items-center gap-2 text-left leading-none"><i data-lucide="settings-2" size="20"></i> Project Settings</h2>
                        <form onsubmit="saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5 text-left">
                            <div class="md:col-span-2 space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2 text-left">Project Name</label><input name="projectName" type="text" value="${window.state.settings.projectName}" class="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-100 font-bold outline-none text-sm text-left" required></div>
                            <div class="space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Start Date</label><input name="startDate" type="date" value="${window.state.settings.startDate}" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-100 font-bold text-sm"></div>
                            <div class="space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">End Date</label><input name="endDate" type="date" value="${window.state.settings.endDate}" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-100 font-bold text-sm"></div>
                            <div class="space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Open</label><input name="startTime" type="time" value="${window.state.settings.startTime}" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-100 font-bold text-sm"></div>
                            <div class="space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Close</label><input name="endTime" type="time" value="${window.state.settings.endTime}" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-100 font-bold text-sm"></div>
                            <div class="md:col-span-2 space-y-2"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2">Service Days</label><div class="flex flex-wrap gap-2">${DAYS_TH.map((d, i) => `<label class="flex items-center gap-2 bg-slate-50 px-3 py-2.5 rounded-xl border border-slate-100 text-[8px] font-bold uppercase cursor-pointer hover:bg-indigo-50"><input type="checkbox" name="day-${i}" ${window.state.settings.availableDays.includes(i) ? 'checked' : ''} class="w-4 h-4 rounded text-indigo-600"> <span>${d}</span></label>`).join('')}</div></div>
                            <div class="space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2 text-left leading-none">Daily (Hr)</label><input name="maxHoursDay" type="number" value="${window.state.settings.maxHoursPerDay}" class="w-full p-3 rounded-xl bg-indigo-50 border border-indigo-100 font-bold text-indigo-600 text-left"></div>
                            <div class="space-y-1.5"><label class="text-[9px] font-bold uppercase text-slate-400 ml-2 text-left leading-none tracking-tighter">Project Total (Hr)</label><input name="maxHoursTotal" type="number" value="${window.state.settings.maxTotalHours}" class="w-full p-3 rounded-xl bg-indigo-50 border border-indigo-100 font-bold text-indigo-600 text-left"></div>
                            <button type="submit" class="md:col-span-2 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg border-b-4 border-indigo-800 text-xs uppercase tracking-widest mt-2">Save Master Admin Configuration</button>
                        </form>
                    </section>
                    <section class="bg-white p-6 rounded-3xl border border-slate-100 shadow-xl space-y-5 text-left"><div class="flex items-center gap-3 text-indigo-600 font-bold text-left leading-none"><i data-lucide="box" size="20"></i><h2>Resources</h2></div><form onsubmit="addRes(event)" class="flex gap-2"><input name="resName" placeholder="เพิ่มใหม่..." class="flex-1 p-3 rounded-xl bg-slate-50 border border-slate-100 font-bold text-sm outline-none text-left" required><button type="submit" class="px-6 bg-slate-900 text-white font-bold rounded-xl text-[9px] uppercase tracking-widest">Add</button></form><div class="grid grid-cols-1 gap-2">${window.state.resources.map(res => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-indigo-200 transition-all text-left"><div class="flex items-center gap-3 text-left"><div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-slate-300 border border-slate-50"><i data-lucide="box" size="16"></i></div><div class="text-left"><p class="font-bold text-slate-800 text-xs leading-none text-left">${res.name}</p><p class="text-[7px] text-slate-400 font-bold uppercase mt-1 tracking-widest text-left">ID: ${res.id}</p></div></div><div class="flex gap-1.5"><button onclick="openQRModal('${res.id}', '${res.name}')" class="p-2 bg-white text-indigo-600 rounded-lg shadow-sm border border-slate-100 active:scale-90"><i data-lucide="qr-code" size="14"></i></button><button onclick="deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', '${res.id}'))" class="p-2 bg-white text-red-400 rounded-lg shadow-sm border border-slate-100 active:scale-90"><i data-lucide="trash-2" size="14"></i></button></div></div>`).join('')}</div></section>
                    <section class="bg-white p-6 rounded-3xl border border-slate-100 shadow-xl space-y-6 overflow-hidden text-left"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 text-left leading-none"><div class="flex items-center gap-3 text-indigo-600 font-bold text-left"><i data-lucide="history" size="20"></i><h2>Activity Log</h2></div><div class="flex gap-2"><button onclick="clearByDay()" class="px-3 py-1.5 bg-slate-100 text-slate-600 text-[8px] font-bold uppercase rounded-lg border border-slate-100 text-center">ลบตามวัน</button><button onclick="clearHistory()" class="px-3 py-1.5 bg-red-50 text-red-500 text-[8px] font-bold uppercase rounded-lg border border-red-100 text-center">ล้างทั้งหมด</button></div></div><div class="overflow-x-auto custom-scrollbar text-left"><table class="w-full text-left"><thead class="border-b border-slate-100 text-[8px] font-bold uppercase text-slate-400 tracking-widest text-left"><tr><th class="py-4">TIME / DATE</th><th class="py-4">USER / ID</th><th class="py-4 text-center">STATUS</th><th class="py-4"></th></tr></thead><tbody class="divide-y divide-slate-50 text-left">${window.state.bookings.slice().sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(b => `<tr class="group hover:bg-slate-50/50 transition-colors text-left"><td class="py-4 leading-tight text-left"><p class="font-bold text-slate-800 text-[11px] tracking-tight text-left">${b.date}</p><p class="text-[8px] text-indigo-500 font-bold mt-0.5 text-left">${b.slot}-59</p></td><td class="py-4 leading-tight text-left"><p class="text-slate-800 font-bold text-[11px] text-left leading-none truncate max-w-[80px]">${b.studentId}</p><p class="text-[7px] text-slate-400 font-bold uppercase mt-1 text-left truncate max-w-[80px]">${b.resourceName}</p></td><td class="py-4 text-center text-center">${b.status === 'checked_in' ? `<span class="px-1.5 py-0.5 bg-green-100 text-green-600 text-[6px] font-bold rounded-full uppercase border border-green-200">Arrived</span>` : `<span class="px-1.5 py-0.5 bg-slate-100 text-slate-400 text-[6px] font-bold rounded-full uppercase border border-slate-200 opacity-60">Wait</span>`}</td><td class="py-4 text-right"><button onclick="deleteBookingEntry('${b.id}')" class="p-1 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 active:scale-75 text-center"><i data-lucide="trash-2" size="14"></i></button></td></tr>`).join('')}</tbody></table></div></section>
                </div>
            `;
        }

        function renderStickyAction() {
            if (window.state.view === 'calendar' && window.state.selectedSlots.length > 0) {
                return `
                    <div class="fixed bottom-24 left-0 right-0 px-6 z-40 max-w-xl mx-auto animate-in slide-in-from-bottom-10 sticky-action-container pt-8 pb-4 flex flex-col items-center">
                        <button onclick="confirmBookingAction()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl transition-all active:scale-95 text-base flex items-center justify-center gap-3 border-b-4 border-indigo-800">
                            <i data-lucide="lock-keyhole" size="18"></i>
                            ยืนยันจอง ${window.state.selectedSlots.length} ช่วงเวลา
                        </button>
                    </div>
                `;
            }
            return "";
        }

        function renderFooter() {
            return `
                <footer class="flex-none bg-white/95 backdrop-blur-md border-t border-slate-100 py-6 px-6 z-40 shadow-inner">
                    <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">
                        <div class="flex items-center gap-3 border-r pr-6 border-slate-100 text-left">
                            <div class="w-8 h-8 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-400 shadow-inner"><i data-lucide="fingerprint" size="14"></i></div>
                            <div><p class="text-[6px] opacity-60 mb-0.5 text-left uppercase leading-none">Session ID</p><p class="text-slate-800 leading-none font-bold text-left uppercase">${window.state.studentId || 'ESTABLISHING'}</p></div>
                        </div>
                        <div class="flex items-center gap-2.5 text-green-500 bg-green-50/50 px-4 py-2 rounded-lg border border-green-100 leading-none text-center">
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse shadow-[0_0_8px_#4ade80]"></div> 
                            <span class="font-bold text-center leading-none">Live Sync</span>
                        </div>
                    </div>
                </footer>
            `;
        }

        function renderQRModalUI() {
            if (!window.state.showQRModal) return "";
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${window.state.showQRModal.id}`;
            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[200] flex items-center justify-center p-6 no-print text-center">
                    <div class="bg-white rounded-3xl p-10 max-w-sm w-full text-center relative shadow-2xl animate-in zoom-in duration-300 border-t-8 border-indigo-600">
                        <button onclick="closeQRModal()" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-800 active:scale-75 text-center border-2 border-slate-50 rounded-full leading-none"><i data-lucide="x" size="24"></i></button>
                        <h3 class="text-xl font-bold mb-1 text-slate-800 tracking-tight uppercase leading-none text-center">${window.state.showQRModal.name}</h3>
                        <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-8 leading-none text-center">Security Access Key</p>
                        <div class="bg-slate-50 p-6 rounded-3xl mb-8 flex items-center justify-center border-2 border-slate-100 shadow-inner">
                            <img src="${qrUrl}" alt="QR" class="w-[150px] h-[150px] rounded-xl shadow-xl">
                        </div>
                        <button onclick="window.print()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-3 active:translate-y-1 text-sm text-center leading-none"><i data-lucide="printer" size="18"></i> พิมพ์รหัส QR เข้าใช้งาน</button>
                    </div>
                </div>
            `;
        }

        function renderError() {
            return `
                <div class="mb-6 p-4 bg-red-50 border border-red-100 text-red-600 rounded-2xl text-[9px] font-bold flex items-center gap-3 animate-in slide-in-from-top-4 shadow-sm text-left">
                    <div class="w-7 h-7 bg-red-100 rounded-lg flex items-center justify-center shrink-0 shadow-inner border border-red-200 text-center leading-none"><i data-lucide="alert-octagon" size="16"></i></div>
                    <p class="flex-1 uppercase leading-relaxed tracking-wider font-bold text-left">${String(window.state.error)}</p>
                    <button onclick="window.state.error=null; render();" class="text-red-300 hover:text-red-600 p-1 active:scale-75 text-center leading-none"><i data-lucide="x-circle" size="18"></i></button>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
