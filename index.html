<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartLab - ระบบจองเครื่องมือวิทยาศาสตร์</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Prompt', 'sans-serif'],
                    },
                    borderRadius: {
                        '4xl': '2rem',
                        '5xl': '2.5rem',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        @keyframes scan-line {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        .animate-scan-line {
            animation: scan-line 2s linear infinite;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        #reader {
            width: 100% !important;
            border: none !important;
        }
        #reader video {
            border-radius: 1.5rem;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbId = "booking-system-v5";

        // --- App State ---
        window.state = {
            user: null,
            studentId: localStorage.getItem('student_id') || '',
            isLoggedIn: !!localStorage.getItem('student_id'),
            isAdmin: false,
            settings: { maxHours: 2, startTime: "09:00", endTime: "18:00", availableDays: [1, 2, 3, 4, 5], startDate: "", endDate: "" },
            resources: [],
            bookings: [],
            selectedResource: null,
            selectedDate: new Date().toISOString().split('T')[0],
            selectedSlots: [],
            view: 'selection',
            activeBookings: [],
            error: null,
            showQRModal: null
        };

        let html5QrScanner = null;
        const DAYS_TH = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];

        // --- Core Functions ---
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    window.state.user = u;
                    if (u) listenToData();
                });
            } catch (err) {
                showError("Firebase Connection Error: " + err.message);
            }
        }

        function listenToData() {
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), (s) => {
                if (s.exists()) window.state.settings = s.data();
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), (s) => {
                window.state.resources = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), (s) => {
                window.state.bookings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        function showError(msg) {
            window.state.error = msg;
            render();
            setTimeout(() => { window.state.error = null; render(); }, 5000);
        }

        // --- Window Exposed Actions ---
        window.render = render;

        window.setView = (v) => { 
            window.state.view = v; 
            if (v !== 'scanner' && html5QrScanner) {
                html5QrScanner.clear();
                html5QrScanner = null;
            }
            render(); 
        };

        window.selectResource = (id, name) => { 
            window.state.selectedResource = { id, name }; 
            window.state.selectedSlots = [];
            window.state.view = 'calendar'; 
            render(); 
        };

        window.toggleAdmin = () => { window.state.isAdmin = !window.state.isAdmin; render(); };
        
        window.logout = () => { 
            localStorage.removeItem('student_id'); 
            window.state.studentId = ''; 
            window.state.isLoggedIn = false; 
            render(); 
        };

        window.handleLogin = (e) => {
            e.preventDefault();
            const id = document.getElementById('login_sid').value;
            if (id.length < 5) return showError("รหัสนักศึกษาไม่ถูกต้อง");
            window.state.studentId = id;
            window.state.isLoggedIn = true;
            localStorage.setItem('student_id', id);
            render();
        };

        window.toggleSlotSelection = (slot) => {
            const index = window.state.selectedSlots.indexOf(slot);
            if (index > -1) {
                window.state.selectedSlots.splice(index, 1);
            } else {
                const alreadyBookedCount = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
                if (alreadyBookedCount + window.state.selectedSlots.length >= window.state.settings.maxHours) {
                    return showError(`คุณจองครบโควตา ${window.state.settings.maxHours} ชม./วัน แล้ว`);
                }
                window.state.selectedSlots.push(slot);
            }
            render();
        };

        window.confirmBooking = async () => {
            if (window.state.selectedSlots.length === 0) return;
            try {
                const newBookings = [];
                for (const slot of window.state.selectedSlots) {
                    const bookingData = {
                        resourceId: window.state.selectedResource.id,
                        resourceName: window.state.selectedResource.name,
                        date: window.state.selectedDate,
                        slot,
                        studentId: window.state.studentId,
                        createdAt: serverTimestamp()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), bookingData);
                    newBookings.push({ id: docRef.id, ...bookingData });
                }
                window.state.activeBookings = newBookings;
                window.state.selectedSlots = [];
                window.state.view = 'pass';
                render();
            } catch (err) {
                showError("จองไม่สำเร็จ: " + err.message);
            }
        };

        window.initScanner = () => {
            if (html5QrScanner) return;
            html5QrScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            html5QrScanner.render((decodedText) => {
                const targetResourceId = window.state.activeBookings[0]?.resourceId;
                if (decodedText === targetResourceId) {
                    html5QrScanner.clear().then(() => {
                        window.verifyScanSuccess(targetResourceId);
                    });
                } else {
                    showError("QR Code ไม่ถูกต้องสำหรับเครื่องนี้");
                }
            }, (err) => {});
        };

        window.verifyScanSuccess = async (id) => {
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id), {
                status: 'in_use',
                currentStudent: window.state.studentId,
                startedAt: new Date().toISOString()
            });
            window.state.view = 'selection';
            window.state.selectedResource = null;
            window.state.activeBookings = [];
            alert("เช็คอินสำเร็จ!");
            render();
        };

        window.stopUsage = async (id) => {
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id), {
                status: 'idle', currentStudent: null, startedAt: null
            });
        };

        window.saveAdminSettings = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const days = DAYS_TH.map((_, i) => f.get(`day-${i}`) ? i : null).filter(x => x !== null);
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                maxHours: parseInt(f.get('maxHours')),
                startTime: f.get('startTime'),
                endTime: f.get('endTime'),
                startDate: f.get('startDate'),
                endDate: f.get('endDate'),
                availableDays: days
            });
            window.state.isAdmin = false;
            render();
        };

        window.addResource = async (e) => {
            e.preventDefault();
            const name = e.target.resName.value;
            await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), { name, status: 'idle' });
            e.target.reset();
        };

        window.deleteBooking = async (id) => {
            await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', id));
        };

        window.openQRModal = (id, name) => {
            window.state.showQRModal = { id, name };
            render();
        };

        window.closeQRModal = () => {
            window.state.showQRModal = null;
            render();
        };

        // --- Helpers ---
        const isSlotTakenByOthers = (slot) => window.state.bookings.some(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id && b.studentId !== window.state.studentId);
        const isSlotTakenByMe = (slot) => window.state.bookings.some(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id && b.studentId === window.state.studentId);
        const getBookingId = (slot) => window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id)?.id;
        
        const isDateAvailable = () => {
            const dateObj = new Date(window.state.selectedDate);
            const dayOfWeek = dateObj.getDay();
            const isInRange = (!window.state.settings.startDate || window.state.selectedDate >= window.state.settings.startDate) &&
                              (!window.state.settings.endDate || window.state.selectedDate <= window.state.settings.endDate);
            return isInRange && window.state.settings.availableDays.includes(dayOfWeek);
        };

        // --- Render Engine ---
        function render() {
            const appDiv = document.getElementById('app');
            if (!window.state.isLoggedIn) {
                appDiv.innerHTML = renderLogin();
            } else {
                appDiv.innerHTML = `
                    ${renderHeader()}
                    <main class="max-w-2xl mx-auto px-6 py-8">
                        ${window.state.error ? renderError() : ''}
                        ${window.state.isAdmin ? renderAdmin() : renderUserView()}
                    </main>
                    ${renderFooter()}
                    ${window.state.showQRModal ? renderQRModal() : ''}
                `;
            }
            lucide.createIcons();
            if (window.state.view === 'scanner') setTimeout(window.initScanner, 100);
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-6 text-center">
                    <div class="max-w-md w-full bg-white rounded-[2.5rem] p-10 shadow-xl border border-slate-100">
                        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-lg shadow-indigo-100"><i data-lucide="scan" size="40"></i></div>
                        <h1 class="text-3xl font-black text-slate-800 mb-2 font-sans">SmartLab</h1>
                        <p class="text-slate-400 text-sm font-medium mb-8">เข้าสู่ระบบจองเครื่องมือวิทยาศาสตร์</p>
                        <form onsubmit="handleLogin(event)" class="space-y-4">
                            <input id="login_sid" type="text" placeholder="รหัสนักศึกษา" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 text-lg font-bold outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg hover:bg-indigo-700 transition-all">เริ่มต้นใช้งาน</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
                    <div class="max-w-2xl mx-auto px-6 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-2 cursor-pointer" onclick="setView('selection'); window.state.selectedResource=null; window.state.activeBookings=[]; render();">
                            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white"><i data-lucide="activity" size="18"></i></div>
                            <h1 class="font-bold text-lg tracking-tight">SmartLab</h1>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="toggleAdmin()" class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-wider transition-all border ${window.state.isAdmin ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-slate-100 text-slate-500'}">
                                ${window.state.isAdmin ? 'ปิดโหมดแอดมิน' : 'โหมดแอดมิน'}
                            </button>
                            <button onclick="logout()" class="p-2 text-slate-400 hover:text-red-500"><i data-lucide="stop-circle" size="18"></i></button>
                        </div>
                    </div>
                </header>
            `;
        }

        function renderUserView() {
            if (window.state.view === 'scanner') return renderScanner();
            if (window.state.view === 'pass') return renderPass();
            if (!window.state.selectedResource) return renderResourceSelection();
            return renderCalendar();
        }

        function renderResourceSelection() {
            return `
                <div class="space-y-6">
                    <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden mb-10">
                        <h2 class="text-3xl font-black mb-1">Std. ${window.state.studentId}</h2>
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest">ยินดีต้อนรับเข้าสู่ระบบจอง</p>
                    </div>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">รายการเครื่องมือ</h3>
                    <div class="grid grid-cols-1 gap-4">
                        ${window.state.resources.map(res => `
                            <button onclick="selectResource('${res.id}', '${res.name}')" class="group bg-white p-5 rounded-[2rem] border shadow-sm hover:shadow-xl transition-all text-left flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center ${res.status === 'in_use' ? 'bg-orange-50 text-orange-500' : 'bg-slate-50 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white'}">
                                        <i data-lucide="monitor" size="28"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-slate-800">${res.name}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="w-2 h-2 rounded-full ${res.status === 'in_use' ? 'bg-orange-400 animate-pulse' : 'bg-green-400'}"></div>
                                            <span class="text-[10px] font-bold uppercase ${res.status === 'in_use' ? 'text-orange-500' : 'text-green-500'}">
                                                ${res.status === 'in_use' ? `In Use by ${res.currentStudent}` : 'Available'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" size="20" class="text-slate-200 group-hover:text-indigo-600"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            const start = parseInt(window.state.settings.startTime.split(':')[0]);
            const end = parseInt(window.state.settings.endTime.split(':')[0]);
            const slots = [];
            for(let i=start; i<end; i++) slots.push(`${i.toString().padStart(2, '0')}:00`);
            const currentSelectedCount = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;

            return `
                <div class="space-y-6">
                    <button onclick="setView('selection'); window.state.selectedResource=null; render();" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 text-[10px] font-black uppercase"><i data-lucide="chevron-left" size="16"></i> กลับ</button>
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm space-y-6">
                        <div class="flex items-center gap-3 text-indigo-600"><i data-lucide="monitor" size="20"></i><h2 class="text-xl font-bold text-slate-800">${window.state.selectedResource.name}</h2></div>
                        <input type="date" value="${window.state.selectedDate}" onchange="window.state.selectedDate=this.value; window.state.selectedSlots=[]; render();" class="w-full p-4 rounded-2xl bg-slate-50 border font-bold text-slate-800 outline-none">
                        
                        ${!isDateAvailable() ? `
                            <div class="p-10 bg-orange-50 border border-orange-100 rounded-3xl text-center">
                                <i data-lucide="alert-circle" size="32" class="mx-auto text-orange-400 mb-2"></i>
                                <p class="font-bold text-orange-700">ไม่เปิดให้บริการในวันที่เลือก</p>
                            </div>
                        ` : `
                            <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-lg">
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-[10px] font-bold uppercase opacity-60">Quota Today</span>
                                    <span class="text-3xl font-black">${currentSelectedCount + window.state.selectedSlots.length} / ${window.state.settings.maxHours}</span>
                                </div>
                                <div class="w-full h-1 bg-white/20 rounded-full overflow-hidden">
                                    <div class="h-full bg-white transition-all" style="width: ${((currentSelectedCount + window.state.selectedSlots.length) / window.state.settings.maxHours) * 100}%"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 gap-3">
                                ${slots.map(slot => {
                                    const isOthers = isSlotTakenByOthers(slot);
                                    const isMine = isSlotTakenByMe(slot);
                                    const isSelecting = window.state.selectedSlots.includes(slot);
                                    let btnClass = "bg-white border-slate-100 text-slate-600 hover:border-indigo-300";
                                    let statusText = "ว่าง";
                                    let action = `toggleSlotSelection('${slot}')`;

                                    if (isOthers) {
                                        btnClass = "bg-slate-100 border-slate-100 text-slate-300 opacity-40 cursor-not-allowed";
                                        statusText = "ไม่ว่าง";
                                        action = "";
                                    } else if (isMine) {
                                        btnClass = "bg-green-50 border-green-500 text-green-700";
                                        statusText = "จองแล้ว (คลิกเพื่อยกเลิก)";
                                        action = `deleteBooking('${getBookingId(slot)}')`;
                                    } else if (isSelecting) {
                                        btnClass = "bg-indigo-600 border-indigo-600 text-white shadow-lg";
                                        statusText = "กำลังเลือก";
                                        action = `toggleSlotSelection('${slot}')`;
                                    }

                                    return `
                                        <button onclick="${action}" class="relative p-5 rounded-2xl border-2 transition-all flex justify-between items-center ${btnClass}">
                                            <div class="text-left">
                                                <span class="text-lg font-black">${slot} - ${slot.split(':')[0]}:59</span>
                                                <p class="text-[10px] font-bold uppercase opacity-70">${statusText}</p>
                                            </div>
                                            ${isMine || isSelecting ? '<i data-lucide="check-circle-2" class="w-6 h-6"></i>' : '<i data-lucide="plus" class="w-6 h-6 opacity-20"></i>'}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                            ${window.state.selectedSlots.length > 0 ? `
                                <button onclick="confirmBooking()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-xl shadow-indigo-100 animate-in fade-in slide-in-from-bottom-4 transition-all active:scale-95">
                                    ยืนยันการจอง (${window.state.selectedSlots.length} ช่วงเวลา)
                                </button>
                            ` : ''}
                        `}
                    </div>
                </div>
            `;
        }

        function renderPass() {
            const dateStr = window.state.activeBookings[0]?.date;
            const resourceName = window.state.activeBookings[0]?.resourceName;
            const slotsStr = window.state.activeBookings.map(b => b.slot).join(', ');
            return `
                <div class="max-w-md mx-auto py-8">
                    <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border border-slate-100">
                        <div class="bg-indigo-600 p-8 text-white text-center">
                            <i data-lucide="ticket" size="48" class="mx-auto mb-4 opacity-50"></i>
                            <h2 class="text-2xl font-black mb-1 font-sans">ใบยืนยันการจอง</h2>
                            <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest">SmartLab Booking Pass</p>
                        </div>
                        <div class="p-8 space-y-6 text-center sm:text-left">
                            <div class="grid grid-cols-1 gap-4">
                                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">เครื่องมือ</p><p class="text-xl font-bold">${resourceName}</p></div>
                                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">รหัสนักศึกษา</p><p class="text-xl font-bold">${window.state.studentId}</p></div>
                                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">วันที่</p><p class="text-lg font-bold">${dateStr}</p></div>
                                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">ช่วงเวลาที่จอง</p><p class="text-lg font-bold text-indigo-600">${slotsStr}</p></div>
                            </div>
                            <div class="pt-6 border-t border-dashed border-slate-200">
                                <button onclick="setView('scanner')" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl flex items-center justify-center gap-2"><i data-lucide="camera" size="20"></i> สแกน QR หน้าเครื่องเพื่อใช้งาน</button>
                                <button onclick="setView('selection'); window.state.activeBookings=[]; render();" class="w-full mt-4 text-xs font-bold text-slate-400">กลับหน้าหลัก</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScanner() {
            return `
                <div class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-6 text-white overflow-hidden">
                    <div class="w-full max-w-md text-center">
                        <div class="mb-8">
                            <h2 class="text-2xl font-black mb-2">สแกนรหัสเครื่องมือ</h2>
                            <p class="text-slate-400 text-sm">สแกน QR Code ที่แปะอยู่บนเครื่องเพื่อเริ่มทำงาน</p>
                        </div>
                        <div class="relative w-full aspect-square bg-black rounded-[2rem] overflow-hidden border-4 border-indigo-500/30">
                            <div id="reader" class="w-full h-full"></div>
                            <div class="absolute inset-0 pointer-events-none border-[3rem] border-black/20"></div>
                            <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.8)] animate-scan-line"></div>
                        </div>
                        <div class="mt-12 space-y-4">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-500 italic">Target Device ID: ${window.state.activeBookings[0]?.resourceId}</p>
                            <button onclick="setView('pass')" class="w-full py-4 bg-white/10 text-white font-bold rounded-2xl">ยกเลิก</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            return `
                <div class="space-y-6">
                    <section class="bg-white p-6 rounded-3xl border shadow-sm">
                        <h2 class="text-lg font-bold mb-4 text-indigo-600 flex items-center gap-2"><i data-lucide="settings" size="20"></i> ตั้งค่าระบบ</h2>
                        <form onsubmit="saveAdminSettings(event)" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <input name="startTime" type="time" value="${window.state.settings.startTime}" class="p-3 rounded-xl bg-slate-50 border text-sm" required>
                                <input name="endTime" type="time" value="${window.state.settings.endTime}" class="p-3 rounded-xl bg-slate-50 border text-sm" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input name="startDate" type="date" value="${window.state.settings.startDate}" class="p-3 rounded-xl bg-slate-50 border text-sm">
                                <input name="endDate" type="date" value="${window.state.settings.endDate}" class="p-3 rounded-xl bg-slate-50 border text-sm">
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${DAYS_TH.map((d, i) => `
                                    <label class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-lg border text-[10px] font-bold">
                                        <input type="checkbox" name="day-${i}" ${window.state.settings.availableDays.includes(i) ? 'checked' : ''}> ${d}
                                    </label>
                                `).join('')}
                            </div>
                            <input name="maxHours" type="number" value="${window.state.settings.maxHours}" class="w-full p-3 rounded-xl bg-slate-50 border text-sm" required>
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">บันทึกการตั้งค่า</button>
                        </form>
                    </section>
                    <section class="bg-white p-6 rounded-3xl border shadow-sm">
                        <h2 class="text-lg font-bold mb-4 text-indigo-600 flex items-center gap-2"><i data-lucide="monitor" size="20"></i> เครื่องมือ</h2>
                        <form onsubmit="addResource(event)" class="flex gap-2 mb-4">
                            <input name="resName" placeholder="ชื่อเครื่อง" class="flex-1 p-3 rounded-xl bg-slate-50 border text-sm outline-none" required>
                            <button type="submit" class="px-4 bg-slate-900 text-white font-bold rounded-xl text-xs">เพิ่ม</button>
                        </form>
                        <div class="space-y-2">
                            ${window.state.resources.map(res => `
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border">
                                    <div><p class="text-sm font-bold">${res.name}</p><p class="text-[10px] text-slate-400 font-bold uppercase">${res.status}</p></div>
                                    <div class="flex gap-1">
                                        <button onclick="openQRModal('${res.id}', '${res.name}')" class="p-2 bg-white text-indigo-600 rounded-lg border shadow-sm"><i data-lucide="qr-code" size="16"></i></button>
                                        <button onclick="deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'resources', '${res.id}'))" class="p-2 text-red-300 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }

        function renderQRModal() {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${window.state.showQRModal.id}`;
            return `
                <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] flex items-center justify-center p-6">
                    <div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full text-center relative shadow-2xl">
                        <button onclick="closeQRModal()" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-600"><i data-lucide="x" size="24"></i></button>
                        <h3 class="text-xl font-black mb-1">${window.state.showQRModal.name}</h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-8">Resource ID: ${window.state.showQRModal.id}</p>
                        <div class="bg-slate-50 p-4 rounded-3xl mb-8 flex items-center justify-center border">
                            <img src="${qrUrl}" alt="QR" class="w-[180px] h-[180px]">
                        </div>
                        <button onclick="window.print()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl flex items-center justify-center gap-2"><i data-lucide="printer" size="18"></i> พิมพ์ใบ QR Code</button>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t py-4 px-6 z-40">
                    <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        <div class="flex items-center gap-2"><i data-lucide="user" size={12} class="text-indigo-400"></i> ID: ${window.state.studentId}</div>
                        <div class="flex items-center gap-1.5 text-green-500 animate-pulse"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Connected</div>
                    </div>
                </footer>
            `;
        }

        function renderError() {
            return `
                <div class="mb-6 p-4 bg-red-50 border border-red-100 text-red-600 rounded-2xl text-[11px] font-bold flex items-center gap-3">
                    <i data-lucide="alert-circle" size="16"></i>
                    <p class="flex-1">${window.state.error}</p>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
