<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Link - One Time View</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react"
      }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            -webkit-user-select: none; /* Chrome/Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
            user-select: none; /* Standard */
        }
        @media print { body { display: none !important; } }
        
        /* Disable Image Interaction on Mobile */
        img {
            -webkit-touch-callout: none; /* iOS Safari */
            pointer-events: none; /* Disable all clicks/touches on image */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, getDoc, onSnapshot, serverTimestamp, collection, query, where, orderBy, deleteField } from 'firebase/firestore';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'firebase/storage';
        import { AlertTriangle, Clock, Eye, EyeOff, Lock, Shield, Share2, Copy, Settings, Trash2, CheckCircle, XCircle, History, Image as ImageIcon, Upload, X, Loader2 } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'github-hosted-v1';

        // --- Helper Components ---

        const Watermark = ({ text }) => {
            return (
                <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden opacity-10 flex flex-wrap content-center justify-center gap-12 rotate-12 select-none">
                {Array.from({ length: 20 }).map((_, i) => (
                    <div key={i} className="text-xl font-bold text-gray-500 whitespace-nowrap">
                    {text || 'SECRET'} - ONE TIME VIEW
                    </div>
                ))}
                </div>
            );
        };

        const SecurityWrapper = ({ children, isBlurred }) => {
            const [blurActive, setBlurActive] = useState(false);
            const [warningMsg, setWarningMsg] = useState('');

            useEffect(() => {
                const handleContextMenu = (e) => e.preventDefault();
                const handleKeyDown = (e) => {
                    // Detect PrintScreen or Shortcuts
                    if (
                        e.key === 'PrintScreen' ||
                        (e.ctrlKey && (e.key === 'p' || e.key === 's' || e.key === 'c' || e.key === 'u')) ||
                        (e.metaKey && (e.key === 'p' || e.key === 's' || e.key === 'c' || e.key === 'u'))
                    ) {
                        e.preventDefault();
                        setBlurActive(true);
                        setWarningMsg('ห้ามบันทึกภาพหน้าจอ!');
                        setTimeout(() => {
                            setBlurActive(false);
                            setWarningMsg('');
                        }, 3000);
                    }
                };

                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        setBlurActive(true);
                    } else {
                        setTimeout(() => setBlurActive(false), 500); 
                    }
                };

                const handleWindowBlur = () => setBlurActive(true);
                const handleWindowFocus = () => setBlurActive(false);

                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('blur', handleWindowBlur);
                window.addEventListener('focus', handleWindowFocus);
                document.addEventListener('touchstart', (e) => {
                   // Optional: prevent zooming or double tap logic if needed
                }, {passive: false});

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    document.removeEventListener('keydown', handleKeyDown);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('blur', handleWindowBlur);
                    window.removeEventListener('focus', handleWindowFocus);
                };
            }, []);

            return (
                <div className="relative w-full min-h-screen bg-black text-white selection:bg-transparent select-none font-sans" onContextMenu={(e)=>e.preventDefault()}>
                {(blurActive || isBlurred) && (
                    <div className="fixed inset-0 z-[100] backdrop-blur-3xl bg-black/95 flex items-center justify-center">
                    <div className="text-center p-8">
                        <EyeOff size={64} className="mx-auto text-red-500 mb-4 animate-pulse" />
                        <h2 className="text-3xl font-bold text-red-500">{warningMsg || 'Security Mode'}</h2>
                        <p className="text-gray-400 mt-2">เนื้อหาถูกซ่อนเพื่อความปลอดภัย</p>
                    </div>
                    </div>
                )}
                {children}
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('landing');
            const [viewLinkId, setViewLinkId] = useState('');
            
            // Admin State
            const [secretMessage, setSecretMessage] = useState('');
            const [selectedImage, setSelectedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0); // Progress bar
            const [timerSeconds, setTimerSeconds] = useState(60);
            const [generatedLink, setGeneratedLink] = useState(null);
            const [history, setHistory] = useState([]);
            const fileInputRef = useRef(null);

            // Viewer State
            const [linkData, setLinkData] = useState(null);
            const [timeLeft, setTimeLeft] = useState(null);
            const [isExpired, setIsExpired] = useState(false);
            const [fetchError, setFetchError] = useState('');

            // Auth Init
            useEffect(() => {
                const initAuth = async () => {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth Error:", error);
                }
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
            }, []);

            // Handle URL Parameters
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id) {
                    setViewLinkId(id);
                    setView('viewer');
                }
            }, []);

            // Handle Image Selection
            const handleImageSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setSelectedImage(file);
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImagePreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const clearImage = () => {
                setSelectedImage(null);
                setImagePreview(null);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            // Admin History Listener
            useEffect(() => {
                if (!user || view !== 'admin') return;

                const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'links'), (snapshot) => {
                const myLinks = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.adminId === user.uid) {
                    myLinks.push({ id: doc.id, ...data });
                    }
                });
                myLinks.sort((a, b) => (b.created?.seconds || 0) - (a.created?.seconds || 0));
                setHistory(myLinks);
                });

                return () => unsubscribe();
            }, [user, view]);

            // Viewer Logic
            useEffect(() => {
                if (view !== 'viewer' || !viewLinkId) return;

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'links', viewLinkId);
                
                const unsubscribe = onSnapshot(docRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    setFetchError('ไม่พบลิงก์นี้ หรือถูกลบไปแล้ว');
                    return;
                }
                
                const data = docSnap.data();
                setLinkData(data);

                if (data.status === 'new') {
                    await updateDoc(docRef, {
                    status: 'viewed',
                    startedAt: serverTimestamp()
                    });
                } else if (data.status === 'viewed' && data.startedAt) {
                    const start = data.startedAt.toMillis ? data.startedAt.toMillis() : Date.now();
                    const durationMs = data.duration * 1000;
                    const end = start + durationMs;
                    const now = Date.now();
                    const diff = Math.floor((end - now) / 1000);

                    if (diff <= 0) {
                        handleExpire(docRef, data);
                    } else {
                        setTimeLeft(diff);
                        setIsExpired(false);
                    }
                } else if (data.status === 'expired') {
                    setIsExpired(true);
                    setTimeLeft(0);
                }
                });

                return () => unsubscribe();
            }, [view, viewLinkId]);

            // Local Timer
            useEffect(() => {
                if (!linkData || isExpired || linkData.status === 'expired') return;

                const interval = setInterval(() => {
                if (linkData.startedAt) {
                    const start = linkData.startedAt.toMillis ? linkData.startedAt.toMillis() : Date.now();
                    const durationMs = linkData.duration * 1000;
                    const end = start + durationMs;
                    const now = Date.now();
                    const diff = Math.floor((end - now) / 1000);

                    if (diff <= 0) {
                        clearInterval(interval);
                        setTimeLeft(0);
                        setIsExpired(true);
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'links', viewLinkId);
                        handleExpire(docRef, linkData);
                    } else {
                        setTimeLeft(diff);
                    }
                }
                }, 1000);
                return () => clearInterval(interval);
            }, [linkData, isExpired, viewLinkId]);

            const handleExpire = async (docRef, data) => {
                try {
                    await updateDoc(docRef, {
                        status: 'expired',
                        message: deleteField(),
                        imageUrl: deleteField(),
                        storagePath: deleteField(),
                        expiredAt: serverTimestamp()
                    });
                    if (data?.storagePath) {
                        const imageRef = ref(storage, data.storagePath);
                        deleteObject(imageRef).catch((e) => console.log("Image delete error", e));
                    }
                    setIsExpired(true);
                } catch (e) {
                    console.error("Expire error", e);
                }
            };

            // --- History Management ---
            const handleDeleteHistoryItem = async (item) => {
                if(!confirm(`ต้องการลบรายการ ${item.id} ใช่หรือไม่? \n(หากยังไม่หมดอายุ ผู้รับจะไม่สามารถดูได้อีก)`)) return;
                
                try {
                    // 1. Delete Firestore Doc
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'links', item.id);
                    await deleteDoc(docRef);

                    // 2. Delete Storage Image (if exists)
                    if (item.storagePath) {
                        const imageRef = ref(storage, item.storagePath);
                        deleteObject(imageRef).catch(err => console.log("Storage cleanup error:", err));
                    }
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการลบ: ' + error.message);
                }
            };

            const handleClearAllHistory = async () => {
                if(!confirm("⚠️ ยืนยันการล้างประวัติทั้งหมด? \nรายการและรูปภาพทั้งหมดจะถูกลบถาวร!")) return;
                
                try {
                    const deletePromises = history.map(item => {
                        // Create promises for deletion
                        const docPromise = deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'links', item.id));
                        let storagePromise = Promise.resolve();
                        if (item.storagePath) {
                            storagePromise = deleteObject(ref(storage, item.storagePath)).catch(() => {});
                        }
                        return Promise.all([docPromise, storagePromise]);
                    });
                    
                    await Promise.all(deletePromises);
                    alert("ล้างประวัติเรียบร้อยแล้ว");
                } catch (error) {
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            };

            // --- Create Link Logic (Updated for Upload Progress) ---
            const createLink = async () => {
                if (!secretMessage && !selectedImage) return;
                setIsUploading(true);
                setUploadProgress(0);
                
                const newId = Math.random().toString(36).substring(2, 10).toUpperCase();
                let storagePath = null;

                try {
                    // Logic to save data after upload
                    const saveToFirestore = async (downloadUrl = null) => {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'links', newId), {
                            adminId: user.uid,
                            message: secretMessage,
                            imageUrl: downloadUrl,
                            storagePath: storagePath,
                            duration: timerSeconds,
                            created: serverTimestamp(),
                            status: 'new',
                            startedAt: null
                        });
                        setGeneratedLink(newId);
                        setSecretMessage('');
                        clearImage();
                        setIsUploading(false);
                        setUploadProgress(0);
                    };

                    // Upload Image if selected with Progress
                    if (selectedImage) {
                        storagePath = `secrets/${user.uid}/${newId}_${selectedImage.name}`;
                        const storageRef = ref(storage, storagePath);
                        const uploadTask = uploadBytesResumable(storageRef, selectedImage);

                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                setUploadProgress(progress);
                            }, 
                            (error) => {
                                console.error("Upload error:", error);
                                alert("อัปโหลดรูปภาพล้มเหลว: " + error.message);
                                setIsUploading(false);
                            }, 
                            async () => {
                                const downloadUrl = await getDownloadURL(uploadTask.snapshot.ref);
                                await saveToFirestore(downloadUrl);
                            }
                        );
                    } else {
                        await saveToFirestore(null);
                    }

                } catch (error) {
                    console.error("Error creating link:", error);
                    alert("เกิดข้อผิดพลาด: " + error.message);
                    setIsUploading(false);
                }
            };

            const formatTime = (seconds) => {
                if (seconds === null || seconds < 0) return "00:00";
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const getShareUrl = (id) => {
                const url = new URL(window.location.href);
                url.searchParams.set('id', id);
                return url.toString();
            };

            // --- Views ---

            if (view === 'landing') {
                return (
                <SecurityWrapper>
                    <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-gradient-to-b from-gray-900 via-black to-gray-900">
                    <div className="max-w-md w-full text-center space-y-8">
                        <div className="flex justify-center">
                            <div className="p-4 bg-emerald-500/10 rounded-full ring-1 ring-emerald-500/50 shadow-lg shadow-emerald-500/20">
                                <Shield className="text-emerald-500 w-16 h-16" />
                            </div>
                        </div>
                        
                        <div>
                            <h1 className="text-4xl font-bold text-white mb-2 tracking-tight">Secret Link</h1>
                            <p className="text-gray-400">ส่งความลับแบบ "เปิดแล้วทำลายตัวเอง"</p>
                        </div>

                        <div className="space-y-4 pt-4">
                        <button 
                            onClick={() => setView('admin')}
                            className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 active:scale-95 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2 group"
                        >
                            <Lock className="w-5 h-5 group-hover:rotate-12 transition-transform" /> สร้างลิงก์ลับ (Admin)
                        </button>
                        
                        <div className="relative py-2">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-800"></div></div>
                            <div className="relative flex justify-center text-xs uppercase tracking-widest text-gray-600 bg-black px-2">หรือ เปิดลิงก์</div>
                        </div>

                        <div className="bg-gray-900/50 p-2 rounded-xl border border-gray-800 flex gap-2">
                            <input 
                            type="text" 
                            placeholder="วางรหัสลิงก์ที่นี่..." 
                            className="flex-1 bg-transparent text-white px-4 py-2 focus:outline-none placeholder-gray-600 text-center font-mono uppercase"
                            onChange={(e) => setViewLinkId(e.target.value.trim())}
                            />
                            <button 
                            onClick={() => {
                                if(viewLinkId) setView('viewer');
                            }}
                            disabled={!viewLinkId}
                            className="px-6 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 text-white font-medium rounded-lg transition-colors"
                            >
                            เปิด
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>
                </SecurityWrapper>
                );
            }

            // --- Admin View ---
            if (view === 'admin') {
                return (
                    <SecurityWrapper>
                        <div className="min-h-screen bg-black p-4 pb-20">
                            <div className="max-w-2xl mx-auto space-y-6 pt-12">
                                {/* Header */}
                                <div className="flex justify-between items-center mb-8">
                                    <button onClick={() => setView('landing')} className="text-gray-400 hover:text-white flex items-center gap-2">
                                        ← กลับหน้าแรก
                                    </button>
                                    <div className="text-emerald-500 font-bold flex items-center gap-2">
                                        <Shield size={16}/> Admin Console
                                    </div>
                                </div>

                                {/* Create Card */}
                                <div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                                    <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                        <Lock size={20} className="text-emerald-500" /> สร้างความลับใหม่
                                    </h2>

                                    {!generatedLink ? (
                                        <div className="space-y-6">
                                            {/* Text Input */}
                                            <div>
                                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-2">ข้อความ (Optional)</label>
                                                <textarea 
                                                    value={secretMessage}
                                                    onChange={(e) => setSecretMessage(e.target.value)}
                                                    className="w-full h-24 bg-black border border-gray-700 rounded-xl p-4 text-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 focus:outline-none resize-none transition-all"
                                                    placeholder="พิมพ์ความลับของคุณ..."
                                                />
                                            </div>

                                            {/* Image Upload */}
                                            <div>
                                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-2">รูปภาพ (Optional - ไม่จำกัดขนาด)</label>
                                                {!imagePreview ? (
                                                    <div 
                                                        onClick={() => fileInputRef.current.click()}
                                                        className="w-full h-32 border-2 border-dashed border-gray-700 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-gray-800/50 transition-all group"
                                                    >
                                                        <ImageIcon className="w-8 h-8 text-gray-500 group-hover:text-emerald-500 mb-2" />
                                                        <span className="text-sm text-gray-500 group-hover:text-gray-300">คลิกเพื่อเลือกรูปภาพ</span>
                                                    </div>
                                                ) : (
                                                    <div className="relative w-full rounded-xl overflow-hidden border border-gray-700 group">
                                                        <img src={imagePreview} alt="Preview" className="w-full h-auto max-h-[300px] object-contain bg-black/50" />
                                                        <button 
                                                            onClick={clearImage}
                                                            className="absolute top-2 right-2 p-1 bg-red-600 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity"
                                                        >
                                                            <X size={16} />
                                                        </button>
                                                    </div>
                                                )}
                                                <input 
                                                    type="file" 
                                                    ref={fileInputRef}
                                                    onChange={handleImageSelect}
                                                    accept="image/*"
                                                    className="hidden" 
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-2">ระยะเวลาทำลายตัวเอง (หลังเปิดอ่าน)</label>
                                                <div className="grid grid-cols-5 gap-2">
                                                    {[5, 10, 30, 60, 300].map(s => (
                                                        <button 
                                                            key={s}
                                                            onClick={() => setTimerSeconds(s)}
                                                            className={`py-2 px-1 rounded-lg text-sm font-medium transition-all ${timerSeconds === s ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/40' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}
                                                        >
                                                            {s < 60 ? `${s} วิ` : `${s/60} นาที`}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <button 
                                                onClick={createLink}
                                                disabled={(!secretMessage && !selectedImage) || isUploading}
                                                className="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg flex items-center justify-center gap-2 relative overflow-hidden"
                                            >
                                                {isUploading && (
                                                    <div 
                                                        className="absolute inset-0 bg-emerald-500/20 transition-all duration-300" 
                                                        style={{width: `${uploadProgress}%`}}
                                                    ></div>
                                                )}
                                                <div className="relative flex items-center gap-2 z-10">
                                                    {isUploading ? (
                                                        <>
                                                            <Loader2 className="animate-spin" size={20} />
                                                            {uploadProgress < 100 ? `กำลังอัปโหลด... ${Math.round(uploadProgress)}%` : 'กำลังบันทึกข้อมูล...'}
                                                        </>
                                                    ) : (
                                                        'สร้างลิงก์ลับ'
                                                    )}
                                                </div>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 animate-in fade-in zoom-in duration-300">
                                            <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-500">
                                                <CheckCircle size={32} />
                                            </div>
                                            <h3 className="text-2xl font-bold text-white mb-2">สร้างสำเร็จ!</h3>
                                            <p className="text-gray-400 mb-6">ส่ง Link นี้ให้เพื่อน เมื่อเพื่อนเปิด เวลาจะนับถอยหลังทันที</p>
                                            
                                            <div className="bg-black border border-gray-700 p-4 rounded-xl flex flex-col gap-4 mb-6">
                                                <div className="text-sm text-gray-500 break-all bg-gray-900 p-2 rounded border border-gray-800">
                                                    {getShareUrl(generatedLink)}
                                                </div>
                                                <div className="flex justify-center gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            navigator.clipboard.writeText(getShareUrl(generatedLink));
                                                            alert('คัดลอก Link แล้ว');
                                                        }}
                                                        className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-bold transition-colors flex items-center gap-2"
                                                    >
                                                        <Copy size={16} /> คัดลอก Link
                                                    </button>
                                                     <button 
                                                        onClick={() => {
                                                            navigator.clipboard.writeText(generatedLink);
                                                            alert('คัดลอกรหัสแล้ว');
                                                        }}
                                                        className="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-white transition-colors"
                                                    >
                                                        คัดลอกเฉพาะรหัส
                                                    </button>
                                                </div>
                                            </div>

                                            <button 
                                                onClick={() => {
                                                    setGeneratedLink(null);
                                                    setSecretMessage('');
                                                    clearImage();
                                                }}
                                                className="text-gray-500 hover:text-white underline text-sm"
                                            >
                                                สร้างเพิ่มอีก
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* History Section */}
                                <div className="space-y-4">
                                    <div className="flex justify-between items-end px-2">
                                        <h3 className="text-lg font-bold text-gray-400 flex items-center gap-2">
                                            <History size={18} /> ประวัติการส่ง
                                        </h3>
                                        {history.length > 0 && (
                                            <button 
                                                onClick={handleClearAllHistory}
                                                className="text-xs text-red-400 hover:text-red-300 underline flex items-center gap-1"
                                            >
                                                <Trash2 size={12} /> ล้างประวัติทั้งหมด
                                            </button>
                                        )}
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {history.length === 0 && (
                                            <div className="text-center py-8 text-gray-600 bg-gray-900/30 rounded-xl border border-dashed border-gray-800">
                                                ยังไม่มีประวัติ
                                            </div>
                                        )}
                                        {history.map((item) => (
                                            <div key={item.id} className="bg-gray-900/50 border border-gray-800 p-4 rounded-xl flex items-center justify-between hover:border-gray-700 transition-colors group">
                                                <div>
                                                    <div className="flex items-center gap-3 mb-1">
                                                        <span className="font-mono text-emerald-500 font-bold">{item.id}</span>
                                                        {item.imageUrl && <ImageIcon size={12} className="text-gray-400" />}
                                                        {item.status === 'new' && <span className="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full border border-blue-500/20">ยังไม่ถูกเปิด</span>}
                                                        {item.status === 'viewed' && <span className="text-[10px] bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded-full border border-yellow-500/20 animate-pulse">กำลังดู...</span>}
                                                        {item.status === 'expired' && <span className="text-[10px] bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full border border-red-500/20">ลบแล้ว</span>}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        {new Date(item.created?.seconds * 1000).toLocaleString('th-TH')}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <div className="text-right text-xs text-gray-600">
                                                        {item.status === 'expired' ? 'Deleted' : `${item.duration}s timer`}
                                                    </div>
                                                    <button 
                                                        onClick={() => handleDeleteHistoryItem(item)}
                                                        className="p-2 text-gray-600 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"
                                                        title="ลบรายการนี้"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </SecurityWrapper>
                );
            }

            // --- Viewer View ---
            if (view === 'viewer') {
                return (
                    <SecurityWrapper>
                        <Watermark text={viewLinkId} />
                        <div className="min-h-screen flex flex-col items-center justify-center p-4">
                            
                            {/* Navbar */}
                            <div className="fixed top-0 left-0 right-0 p-4 flex justify-between z-50">
                                <div className="font-mono text-xs text-gray-600">ID: {viewLinkId}</div>
                                {/* Removed Home/Back button */}
                            </div>

                            {fetchError ? (
                                <div className="text-center text-red-500 space-y-4">
                                    <XCircle size={64} className="mx-auto" />
                                    <h2 className="text-2xl font-bold">{fetchError}</h2>
                                    {/* Removed Return to Home button */}
                                </div>
                            ) : !linkData ? (
                                <div className="animate-pulse flex flex-col items-center">
                                    <div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <p className="text-emerald-500 font-mono">กำลังถอดรหัส...</p>
                                </div>
                            ) : isExpired || linkData.status === 'expired' ? (
                                <div className="text-center max-w-md w-full p-8 bg-red-900/10 border border-red-900/50 rounded-2xl backdrop-blur-sm">
                                    <Lock size={64} className="mx-auto text-red-600 mb-6" />
                                    <h2 className="text-3xl font-bold text-red-500 mb-2">ข้อความถูกทำลายแล้ว</h2>
                                    <p className="text-gray-400">เนื้อหาในลิงก์นี้หมดอายุและถูกลบออกจากเซิร์ฟเวอร์อย่างถาวร</p>
                                </div>
                            ) : (
                                <div className="w-full max-w-3xl relative">
                                    {/* Timer Card */}
                                    <div className="absolute -top-20 left-1/2 -translate-x-1/2 bg-gray-900 border border-emerald-900/50 px-6 py-2 rounded-full flex items-center gap-3 shadow-lg shadow-emerald-900/20 z-10">
                                        <Clock size={16} className="text-emerald-500 animate-pulse" />
                                        <span className={`font-mono font-bold text-xl ${timeLeft <= 10 ? 'text-red-500' : 'text-emerald-400'}`}>
                                            {formatTime(timeLeft)}
                                        </span>
                                    </div>

                                    {/* Content Card */}
                                    <div className="bg-gray-900/80 border border-gray-800 p-8 md:p-12 rounded-3xl shadow-2xl relative overflow-hidden group">
                                        <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-transparent pointer-events-none"></div>
                                        
                                        <h3 className="text-gray-500 text-xs uppercase tracking-[0.3em] mb-8 text-center border-b border-gray-800 pb-4">
                                            Secure Transmission
                                        </h3>
                                        
                                        <div className="flex flex-col items-center gap-8">
                                            {/* Image Display */}
                                            {linkData.imageUrl && (
                                                <div className="relative w-full rounded-xl overflow-hidden border border-gray-700 bg-black/50">
                                                    <img 
                                                        src={linkData.imageUrl} 
                                                        alt="Secure Content" 
                                                        className="w-full h-auto max-h-[70vh] object-contain pointer-events-none select-none"
                                                        style={{ WebkitTouchCallout: 'none', WebkitUserSelect: 'none', userSelect: 'none' }}
                                                        draggable="false"
                                                        onContextMenu={(e) => e.preventDefault()}
                                                        onTouchStart={(e) => {
                                                             if(e.touches.length > 1) e.preventDefault();
                                                        }}
                                                    />
                                                </div>
                                            )}

                                            {/* Text Display */}
                                            {linkData.message && (
                                                <div className="text-2xl md:text-4xl font-bold text-white text-center leading-relaxed font-sans break-words w-full">
                                                    {linkData.message}
                                                </div>
                                            )}
                                        </div>

                                        <div className="mt-12 flex justify-center items-center gap-2 text-xs text-red-500/60 font-mono">
                                            <AlertTriangle size={12} />
                                            SELF-DESTRUCT SEQUENCE INITIATED
                                        </div>
                                    </div>

                                    <p className="text-center text-gray-600 text-xs mt-6">
                                        ห้ามกด Back, ห้าม Refresh, ห้ามสลับหน้าจอ (เวลาจะยังเดินต่อ)
                                    </p>
                                </div>
                            )}
                        </div>
                    </SecurityWrapper>
                );
            }
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
